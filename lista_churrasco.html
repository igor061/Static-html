<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checklist do Churrasco (grupos + subgrupos + import/export)</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b0c10; color:#e9eef6; }
    .app { max-width: 900px; margin: 0 auto; padding: 16px 14px 32px; }

    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(#0b0c10 70%, rgba(11,12,16,0));
      padding: 10px 0 12px;
      backdrop-filter: blur(6px);
    }
    h1 { margin: 6px 0 10px; font-size: 20px; font-weight: 900; letter-spacing: .2px; }
    .muted { color:#aab6c7; font-size:12px; line-height:1.35; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    input[type="text"], select, textarea {
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: inherit;
      outline: none;
      font-size: 16px;
    }
    input[type="text"]{ flex:1; min-width: 180px; }
    select { font-size: 14px; }
    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.10);
      color: inherit;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button:active { transform: scale(.98); }
    .pill {
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size: 12px; color:#cfe1ff;
    }

    .groups { margin-top: 14px; display:flex; flex-direction: column; gap: 14px; }
    details {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      overflow: clip;
    }
    summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 12px;
      display:flex; align-items:center; justify-content: space-between; gap:10px;
      user-select: none;
    }
    summary::-webkit-details-marker { display:none; }
    .gTitle { font-weight: 900; font-size: 15px; }
    .gMeta { display:flex; gap:10px; align-items:center; }
    .gCount { font-size: 12px; color:#aab6c7; }

    .subgroupBox { padding: 8px 10px 12px; display:flex; flex-direction: column; gap: 12px; }
    .sgHeader {
      display:flex; align-items:center; justify-content: space-between; gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .sgName { font-weight: 900; font-size: 13px; }
    .sgMeta { font-size: 12px; color:#aab6c7; }
    .list { margin-top: 8px; display:flex; flex-direction: column; gap: 10px; }

    .item {
      display:flex; gap:10px; align-items:center;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .item.checked { opacity:.78; }
    .item .text { flex:1; font-size:16px; line-height:1.2; word-break: break-word; }
    .item.checked .text { text-decoration: line-through; color:#b7c1d1; }
    .actions { display:flex; gap:8px; align-items:center; }

    .iconBtn {
      padding: 10px 10px;
      border-radius: 12px;
      min-width: 42px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
    }
    .moveBtn { font-size: 14px; min-width: 40px; padding: 10px 8px; }
    .danger { border-color: rgba(255,80,80,.35); background: rgba(255,80,80,.12); }

    .chk { width: 24px; height: 24px; accent-color:#6ea8fe; transform: translateY(1px); cursor:pointer; }

    .footer {
      margin-top: 14px;
      display:flex; justify-content: space-between; align-items:center;
      gap:10px; flex-wrap: wrap;
    }

    dialog {
      width: min(720px, calc(100% - 24px));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 14px;
      background: #0f1118;
      color:#e9eef6;
    }
    dialog::backdrop { background: rgba(0,0,0,.55); }
    .dlgTitle { font-weight: 900; margin: 2px 0 10px; }
    .dlgBtns { display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    .dlgRow { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .dlgRow label { font-size: 12px; color:#aab6c7; width:100%; }
    .small { font-size: 12px; color:#aab6c7; }

    textarea { width: 100%; min-height: 220px; resize: vertical; font-size: 14px; line-height: 1.35; }
    code.kbd { padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1>Checklist do Churrasco</h1>
      <div class="muted">
        ‚úÖ Salva em <b>cookies</b>. <b>Marcou</b>? vai pro <b>final do subgrupo</b>. <br/>
        ‚ÜïÔ∏è Mudar ordem manual: <b>‚Üë / ‚Üì</b> no item (dentro do mesmo status). <br/>
        üìÑ Import/Export: texto com indenta√ß√£o:
        <br/>- Grupo: sem espa√ßos
        <br/>- Subgrupo: <code class="kbd">‚ê†‚ê†</code> (dois espa√ßos)
        <br/>- Item: <code class="kbd">‚ê†‚ê†‚ê†‚ê†</code> (quatro espa√ßos) com <code class="kbd">- [ ]</code> ou <code class="kbd">- [x]</code>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <input id="newItem" type="text" placeholder="Adicionar item (ex: carv√£o, gelo, picanha...)" />
        <select id="newGroup"></select>
        <select id="newSubgroup"></select>
        <button id="addBtn">Adicionar</button>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <span class="pill" id="statsPill">0 itens</span>
        <span class="muted" id="saveStatus"></span>
        <span style="flex:1"></span>
        <button id="manageBtn">Grupos</button>
        <button id="exportBtn">Exportar</button>
        <button id="importBtn">Importar</button>
      </div>
    </header>

    <main class="groups" id="groups"></main>

    <div class="footer">
      <span class="muted">Dica: toque no texto ou ‚úèÔ∏è para editar (inclui trocar grupo/subgrupo).</span>
      <button class="danger" id="clearCheckedBtn" title="Remove apenas os itens marcados">Excluir marcados</button>
    </div>
  </div>

  <!-- Edit item -->
  <dialog id="editDialog">
    <div class="dlgTitle">Editar item</div>

    <div class="dlgRow">
      <label>Texto</label>
      <input id="editInput" type="text" style="width:100%" />
    </div>

    <div style="height:10px"></div>

    <div class="dlgRow">
      <div style="flex:1; min-width: 220px;">
        <label>Grupo</label>
        <select id="editGroup" style="width:100%"></select>
      </div>
      <div style="flex:1; min-width: 220px;">
        <label>Subgrupo</label>
        <select id="editSubgroup" style="width:100%"></select>
      </div>
      <div style="flex:1; min-width: 220px;">
        <label>Status</label>
        <select id="editChecked" style="width:100%">
          <option value="0">N√£o marcado</option>
          <option value="1">Marcado</option>
        </select>
      </div>
    </div>

    <div class="dlgBtns">
      <button id="dlgCancel">Cancelar</button>
      <button class="danger" id="dlgDelete">Excluir</button>
      <button id="dlgSave">Salvar</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Se marcar, o item vai pro final do subgrupo.
    </div>
  </dialog>

  <!-- Manage groups/subgroups -->
  <dialog id="manageDialog">
    <div class="dlgTitle">Gerenciar grupos</div>

    <div class="dlgRow">
      <label>Novo grupo</label>
      <input id="newGroupName" type="text" placeholder="Ex: Sobremesas" style="flex:1" />
      <button id="addGroupBtn">Criar</button>
    </div>

    <div style="height:10px"></div>
    <div id="manageList"></div>

    <div class="dlgBtns">
      <button id="manageClose">Fechar</button>
    </div>

    <div class="small">
      Ao excluir um grupo, todos os subgrupos e itens dele s√£o removidos.
    </div>
  </dialog>

  <!-- Export -->
  <dialog id="exportDialog">
    <div class="dlgTitle">Exportar (texto)</div>
    <div class="small" style="margin-bottom:8px;">Copie e salve como <b>.txt</b> (ou use ‚ÄúBaixar‚Äù).</div>
    <textarea id="exportText" readonly></textarea>
    <div class="dlgBtns">
      <button id="copyExport">Copiar</button>
      <button id="downloadExport">Baixar .txt</button>
      <button id="closeExport">Fechar</button>
    </div>
  </dialog>

  <!-- Import -->
  <dialog id="importDialog">
    <div class="dlgTitle">Importar (texto)</div>
    <div class="small" style="margin-bottom:8px;">
      Cola o texto aqui. A importa√ß√£o <b>substitui</b> sua lista atual (com confirma√ß√£o).
    </div>
    <textarea id="importText" placeholder="Cole aqui o texto exportado..."></textarea>
    <div class="dlgBtns">
      <button id="closeImport">Cancelar</button>
      <button class="danger" id="doImport">Importar</button>
    </div>
  </dialog>

  <script>
    // ================= Cookies =================
    const COOKIE_NAME = "bbq_checklist_groups_v3";
    const COOKIE_DAYS = 365;

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie =
        name + "=" + encodeURIComponent(value) +
        "; expires=" + expires +
        "; path=/; SameSite=Lax";
    }
    function getCookie(name) {
      const cookies = document.cookie ? document.cookie.split("; ") : [];
      for (const c of cookies) {
        const [k, ...rest] = c.split("=");
        if (k === name) return decodeURIComponent(rest.join("="));
      }
      return null;
    }

    // ================= State =================
    // v3: data = { groups:[], subgroups:[], items:[] }
    // group: {id,name,order,open}
    // subgroup: {id,groupId,name,order}
    // item: {id,text,groupId,subgroupId,checked,order,createdAt}
    let data = { groups: [], subgroups: [], items: [] };

    // ================= DOM =================
    const $groups = document.getElementById("groups");
    const $newItem = document.getElementById("newItem");
    const $newGroup = document.getElementById("newGroup");
    const $newSubgroup = document.getElementById("newSubgroup");
    const $addBtn = document.getElementById("addBtn");
    const $statsPill = document.getElementById("statsPill");
    const $saveStatus = document.getElementById("saveStatus");
    const $clearCheckedBtn = document.getElementById("clearCheckedBtn");

    const $editDialog = document.getElementById("editDialog");
    const $editInput = document.getElementById("editInput");
    const $editGroup = document.getElementById("editGroup");
    const $editSubgroup = document.getElementById("editSubgroup");
    const $editChecked = document.getElementById("editChecked");
    const $dlgCancel = document.getElementById("dlgCancel");
    const $dlgSave = document.getElementById("dlgSave");
    const $dlgDelete = document.getElementById("dlgDelete");

    const $manageBtn = document.getElementById("manageBtn");
    const $manageDialog = document.getElementById("manageDialog");
    const $manageList = document.getElementById("manageList");
    const $newGroupName = document.getElementById("newGroupName");
    const $addGroupBtn = document.getElementById("addGroupBtn");
    const $manageClose = document.getElementById("manageClose");

    const $exportBtn = document.getElementById("exportBtn");
    const $importBtn = document.getElementById("importBtn");
    const $exportDialog = document.getElementById("exportDialog");
    const $exportText = document.getElementById("exportText");
    const $copyExport = document.getElementById("copyExport");
    const $downloadExport = document.getElementById("downloadExport");
    const $closeExport = document.getElementById("closeExport");

    const $importDialog = document.getElementById("importDialog");
    const $importText = document.getElementById("importText");
    const $closeImport = document.getElementById("closeImport");
    const $doImport = document.getElementById("doImport");

    let editingId = null;

    function uuid() {
      return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
    }

    function persist() {
      try {
        setCookie(COOKIE_NAME, JSON.stringify(data), COOKIE_DAYS);
        $saveStatus.textContent = "salvo";
        setTimeout(() => ($saveStatus.textContent = ""), 900);
      } catch (e) {
        $saveStatus.textContent = "erro ao salvar";
      }
    }

    // ================= Helpers =================
    function sortGroups() { data.groups.sort((a,b) => (a.order ?? 0) - (b.order ?? 0)); }
    function sortSubgroups(groupId) {
      return data.subgroups
        .filter(sg => sg.groupId === groupId)
        .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
    }

    function getGroup(id) { return data.groups.find(g => g.id === id); }
    function getSubgroup(id) { return data.subgroups.find(sg => sg.id === id); }

    function ensureDefaultSubgroup(groupId) {
      let sg = data.subgroups.find(x => x.groupId === groupId && x.name === "Geral");
      if (!sg) {
        sg = { id: uuid(), groupId, name: "Geral", order: 10 };
        data.subgroups.push(sg);
      }
      return sg.id;
    }

    function maxSubgroupOrder(groupId) {
      const arr = data.subgroups.filter(sg => sg.groupId === groupId);
      return arr.length ? Math.max(...arr.map(sg => sg.order ?? 0)) : 0;
    }
    function maxItemOrder(subgroupId) {
      const arr = data.items.filter(i => i.subgroupId === subgroupId);
      return arr.length ? Math.max(...arr.map(i => i.order ?? 0)) : 0;
    }

    function itemsInSubgroup(subgroupId) {
      const inSg = data.items.filter(i => i.subgroupId === subgroupId);
      const a = inSg.filter(i => !i.checked).sort((x,y) => (x.order ?? 0) - (y.order ?? 0));
      const b = inSg.filter(i => i.checked).sort((x,y) => (x.order ?? 0) - (y.order ?? 0));
      return [...a, ...b];
    }

    function normalizeItemOrders(subgroupId) {
      const list = itemsInSubgroup(subgroupId);
      list.forEach((it, idx) => it.order = (idx + 1) * 10);
    }

    function fillGroupSelect(selectEl, selectedId) {
      selectEl.innerHTML = "";
      sortGroups();
      for (const g of data.groups) {
        const opt = document.createElement("option");
        opt.value = g.id;
        opt.textContent = g.name;
        if (g.id === selectedId) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    function fillSubgroupSelect(selectEl, groupId, selectedSubId) {
      selectEl.innerHTML = "";
      const subs = sortSubgroups(groupId);
      if (!subs.length) ensureDefaultSubgroup(groupId);

      const subs2 = sortSubgroups(groupId);
      for (const sg of subs2) {
        const opt = document.createElement("option");
        opt.value = sg.id;
        opt.textContent = sg.name;
        if (sg.id === selectedSubId) opt.selected = true;
        selectEl.appendChild(opt);
      }
    }

    function updateStats() {
      const total = data.items.length;
      const done = data.items.filter(i => i.checked).length;
      $statsPill.textContent = `${done}/${total} marcados`;
    }

    // ================= Actions: items =================
    function addItem(text, groupId, subgroupId) {
      const t = (text || "").trim();
      if (!t) return;

      const gid = groupId || data.groups[0]?.id;
      const sgid = subgroupId || ensureDefaultSubgroup(gid);

      data.items.push({
        id: uuid(),
        text: t,
        groupId: gid,
        subgroupId: sgid,
        checked: false,
        order: maxItemOrder(sgid) + 10,
        createdAt: Date.now()
      });

      normalizeItemOrders(sgid);
      $newItem.value = "";
      persist();
      render();
    }

    function removeItem(id) {
      const it = data.items.find(i => i.id === id);
      data.items = data.items.filter(i => i.id !== id);
      if (it) normalizeItemOrders(it.subgroupId);
      persist();
      render();
    }

    function toggleChecked(id, checked) {
      const it = data.items.find(i => i.id === id);
      if (!it) return;
      it.checked = !!checked;
      // vai pro fim do subgrupo
      it.order = maxItemOrder(it.subgroupId) + 10;
      normalizeItemOrders(it.subgroupId);
      persist();
      render();
    }

    function moveItemWithinSubgroup(id, direction) {
      const it = data.items.find(i => i.id === id);
      if (!it) return;

      const list = itemsInSubgroup(it.subgroupId);
      const idx = list.findIndex(x => x.id === id);
      if (idx < 0) return;

      const targetIdx = idx + direction;
      if (targetIdx < 0 || targetIdx >= list.length) return;

      const other = list[targetIdx];

      // S√≥ deixa mover dentro do mesmo status (marcado com marcado / desmarcado com desmarcado)
      if (it.checked !== other.checked) return;

      const tmp = it.order;
      it.order = other.order;
      other.order = tmp;

      persist();
      render();
    }

    // ================= Edit dialog =================
    function openEdit(id) {
      const it = data.items.find(i => i.id === id);
      if (!it) return;
      editingId = id;

      $editInput.value = it.text;
      fillGroupSelect($editGroup, it.groupId);
      fillSubgroupSelect($editSubgroup, it.groupId, it.subgroupId);
      $editChecked.value = it.checked ? "1" : "0";

      $editDialog.showModal();
      setTimeout(() => $editInput.focus(), 50);
    }

    function saveEdit() {
      if (!editingId) return;
      const it = data.items.find(i => i.id === editingId);
      if (!it) return;

      const newText = ($editInput.value || "").trim();
      if (!newText) return;

      const oldSg = it.subgroupId;
      const oldG = it.groupId;

      const newG = $editGroup.value;
      fillSubgroupSelect($editSubgroup, newG, $editSubgroup.value); // garante options
      const newSg = $editSubgroup.value || ensureDefaultSubgroup(newG);

      const newChecked = ($editChecked.value === "1");

      it.text = newText;

      // mudou de grupo/subgrupo
      if (newG !== oldG || newSg !== oldSg) {
        it.groupId = newG;
        it.subgroupId = newSg;
        it.order = maxItemOrder(newSg) + 10;
        normalizeItemOrders(oldSg);
        normalizeItemOrders(newSg);
      }

      // mudou checked
      if (newChecked !== it.checked) {
        it.checked = newChecked;
        it.order = maxItemOrder(it.subgroupId) + 10;
        normalizeItemOrders(it.subgroupId);
      }

      editingId = null;
      $editDialog.close();
      persist();
      render();
    }

    // ================= Groups management =================
    function addGroup(name) {
      const n = (name || "").trim();
      if (!n) return;
      const id = uuid();
      const ord = data.groups.length ? Math.max(...data.groups.map(g => g.order ?? 0)) + 10 : 10;

      data.groups.push({ id, name: n, order: ord, open: true });
      ensureDefaultSubgroup(id);

      persist();
      render();
    }

    function deleteGroup(groupId) {
      // remove items, subgroups, group
      data.items = data.items.filter(i => i.groupId !== groupId);
      data.subgroups = data.subgroups.filter(sg => sg.groupId !== groupId);
      data.groups = data.groups.filter(g => g.id !== groupId);

      // se ficou vazio, re-seed m√≠nimo
      if (!data.groups.length) seedDefaults();

      persist();
      render();
    }

    function addSubgroup(groupId, name) {
      const n = (name || "").trim();
      if (!n) return;
      const ord = maxSubgroupOrder(groupId) + 10;
      data.subgroups.push({ id: uuid(), groupId, name: n, order: ord });
      persist();
      render();
    }

    function deleteSubgroup(subgroupId) {
      const sg = getSubgroup(subgroupId);
      if (!sg) return;
      // move itens para "Geral" do grupo
      const defaultSg = ensureDefaultSubgroup(sg.groupId);
      for (const it of data.items.filter(i => i.subgroupId === subgroupId)) {
        it.subgroupId = defaultSg;
        it.order = maxItemOrder(defaultSg) + 10;
        it.groupId = sg.groupId;
      }
      normalizeItemOrders(defaultSg);

      data.subgroups = data.subgroups.filter(x => x.id !== subgroupId);
      persist();
      render();
    }

    function renderManageDialog() {
      sortGroups();
      $manageList.innerHTML = "";

      for (const g of data.groups) {
        const box = document.createElement("div");
        box.style.margin = "10px 0";
        box.style.padding = "10px";
        box.style.border = "1px solid rgba(255,255,255,.10)";
        box.style.borderRadius = "14px";
        box.style.background = "rgba(255,255,255,.04)";

        const header = document.createElement("div");
        header.className = "row";

        const title = document.createElement("div");
        title.style.fontWeight = "900";
        title.style.flex = "1";
        title.textContent = g.name;

        const del = document.createElement("button");
        del.className = "danger";
        del.textContent = "Excluir grupo";
        del.addEventListener("click", () => {
          const count = data.items.filter(i => i.groupId === g.id).length;
          if (confirm(`Excluir o grupo "${g.name}"?\nIsso remove ${count} item(ns).`)) deleteGroup(g.id);
          renderManageDialog();
        });

        header.appendChild(title);
        header.appendChild(del);

        const sgRow = document.createElement("div");
        sgRow.className = "row";
        sgRow.style.marginTop = "10px";

        const sgInput = document.createElement("input");
        sgInput.type = "text";
        sgInput.placeholder = "Novo subgrupo (ex: Carnes, Drinks...)";
        sgInput.style.flex = "1";

        const sgBtn = document.createElement("button");
        sgBtn.textContent = "Criar subgrupo";
        sgBtn.addEventListener("click", () => {
          addSubgroup(g.id, sgInput.value);
          sgInput.value = "";
          renderManageDialog();
        });

        sgRow.appendChild(sgInput);
        sgRow.appendChild(sgBtn);

        const sgList = document.createElement("div");
        sgList.style.marginTop = "10px";
        const subs = sortSubgroups(g.id);

        for (const sg of subs) {
          const line = document.createElement("div");
          line.className = "row";
          line.style.margin = "8px 0";

          const label = document.createElement("div");
          label.style.flex = "1";
          label.style.color = "#cfe1ff";
          label.style.fontSize = "13px";
          const nItems = data.items.filter(i => i.subgroupId === sg.id).length;
          label.textContent = `‚Ä¢ ${sg.name} (${nItems})`;

          const delSg = document.createElement("button");
          delSg.className = "danger";
          delSg.textContent = "Excluir";
          delSg.disabled = (sg.name === "Geral"); // evita remover o default
          delSg.title = delSg.disabled ? 'Subgrupo "Geral" n√£o pode ser exclu√≠do' : "Excluir subgrupo";
          delSg.addEventListener("click", () => {
            if (confirm(`Excluir subgrupo "${sg.name}"?\nItens dele v√£o para "Geral".`)) deleteSubgroup(sg.id);
            renderManageDialog();
          });

          line.appendChild(label);
          line.appendChild(delSg);
          sgList.appendChild(line);
        }

        box.appendChild(header);
        box.appendChild(sgRow);
        box.appendChild(sgList);

        $manageList.appendChild(box);
      }
    }

    // ================= Export / Import =================
    function exportAsText() {
      sortGroups();
      let out = [];
      for (const g of data.groups) {
        out.push(g.name);

        const subs = sortSubgroups(g.id);
        for (const sg of subs) {
          out.push("  " + sg.name);

          const list = itemsInSubgroup(sg.id);
          for (const it of list) {
            const mark = it.checked ? "x" : " ";
            out.push(`    - [${mark}] ${it.text}`);
          }
        }

        out.push(""); // linha em branco entre grupos
      }
      return out.join("\n").trimEnd() + "\n";
    }

    function parseImportText(text) {
      const lines = (text || "").split(/\r?\n/);
      const nd = { groups: [], subgroups: [], items: [] };

      const groupByName = new Map();
      const subgroupByKey = new Map(); // key = groupId + "::" + name

      function addG(name) {
        const n = name.trim();
        if (!n) return null;
        if (groupByName.has(n)) return groupByName.get(n);
        const g = { id: uuid(), name: n, order: (nd.groups.length + 1) * 10, open: true };
        nd.groups.push(g);
        groupByName.set(n, g);
        return g;
      }

      function addSG(groupId, name) {
        const n = name.trim();
        if (!n) return null;
        const key = groupId + "::" + n;
        if (subgroupByKey.has(key)) return subgroupByKey.get(key);
        const sg = { id: uuid(), groupId, name: n, order: (nd.subgroups.filter(x => x.groupId === groupId).length + 1) * 10 };
        nd.subgroups.push(sg);
        subgroupByKey.set(key, sg);
        return sg;
      }

      let curG = null;
      let curSG = null;

      // fallback
      function ensureFallbackGroup() {
        if (!curG) curG = addG("Sem grupo");
        if (!curSG) curSG = addSG(curG.id, "Geral");
      }

      for (const raw of lines) {
        const line = raw.replace(/\t/g, "  "); // tabs -> 2 spaces
        const trimmed = line.trim();
        if (!trimmed) continue;
        if (trimmed.startsWith("#")) continue;

        const leading = line.match(/^ */)?.[0]?.length ?? 0;

        if (leading < 2) {
          // Group
          curG = addG(trimmed);
          curSG = addSG(curG.id, "Geral"); // garante
          continue;
        }

        if (leading >= 2 && leading < 4) {
          // Subgroup (2 spaces)
          if (!curG) curG = addG("Sem grupo");
          curSG = addSG(curG.id, trimmed);
          continue;
        }

        // Item (4+ spaces)
        ensureFallbackGroup();

        // aceita:
        // - [x] item
        // - [ ] item
        // [x] item
        // item
        let t = trimmed;
        let checked = false;

        const m1 = t.match(/^-?\s*\[\s*([xX])\s*\]\s*(.+)$/);
        const m2 = t.match(/^-?\s*\[\s*([ ])\s*\]\s*(.+)$/);
        const m3 = t.match(/^-?\s*-\s*\[\s*([xX ])\s*\]\s*(.+)$/);

        if (m3) {
          checked = (m3[1].toLowerCase() === "x");
          t = m3[2];
        } else if (m1) {
          checked = true; t = m1[2];
        } else if (m2) {
          checked = false; t = m2[2];
        } else {
          // remove um "-" inicial se tiver
          t = t.replace(/^-+\s*/, "");
        }

        t = (t || "").trim();
        if (!t) continue;

        // cria item
        const sgid = curSG?.id || addSG(curG.id, "Geral").id;
        const order = (nd.items.filter(i => i.subgroupId === sgid).length + 1) * 10;
        nd.items.push({
          id: uuid(),
          text: t,
          groupId: curG.id,
          subgroupId: sgid,
          checked,
          order,
          createdAt: Date.now()
        });
      }

      // se nada criado
      if (!nd.groups.length) return null;

      // normaliza: garante "Geral" em todos os grupos
      for (const g of nd.groups) {
        const hasGeral = nd.subgroups.some(sg => sg.groupId === g.id && sg.name === "Geral");
        if (!hasGeral) nd.subgroups.push({ id: uuid(), groupId: g.id, name: "Geral", order: 10 });
      }

      // regra visual: n√£o-marcados antes; mas na import a ordem j√° vem, ent√£o ok.
      return nd;
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ================= Render =================
    function renderNewSelectors() {
      fillGroupSelect($newGroup, $newGroup.value || data.groups[0]?.id);
      const gid = $newGroup.value || data.groups[0]?.id;
      const fallbackSg = ensureDefaultSubgroup(gid);
      fillSubgroupSelect($newSubgroup, gid, $newSubgroup.value || fallbackSg);
    }

    function render() {
      sortGroups();
      renderNewSelectors();

      $groups.innerHTML = "";

      for (const g of data.groups) {
        const subs = sortSubgroups(g.id);
        const groupItems = data.items.filter(i => i.groupId === g.id);
        const done = groupItems.filter(i => i.checked).length;
        const total = groupItems.length;

        const details = document.createElement("details");
        details.open = (g.open ?? true);
        details.addEventListener("toggle", () => { g.open = details.open; persist(); });

        const summary = document.createElement("summary");
        const left = document.createElement("div");
        left.className = "gTitle";
        left.textContent = g.name;

        const right = document.createElement("div");
        right.className = "gMeta";
        const cnt = document.createElement("div");
        cnt.className = "gCount";
        cnt.textContent = `${done}/${total} marcados`;
        right.appendChild(cnt);

        summary.appendChild(left);
        summary.appendChild(right);

        const box = document.createElement("div");
        box.className = "subgroupBox";

        if (!subs.length) ensureDefaultSubgroup(g.id);

        const subs2 = sortSubgroups(g.id);
        for (const sg of subs2) {
          const sgItems = itemsInSubgroup(sg.id);
          const sgDone = sgItems.filter(i => i.checked).length;
          const sgTotal = sgItems.length;

          const sgWrap = document.createElement("div");

          const sgHeader = document.createElement("div");
          sgHeader.className = "sgHeader";
          const sgL = document.createElement("div");
          sgL.innerHTML = `<div class="sgName">${sg.name}</div><div class="sgMeta">${sgDone}/${sgTotal} marcados</div>`;
          sgHeader.appendChild(sgL);

          sgWrap.appendChild(sgHeader);

          const list = document.createElement("div");
          list.className = "list";

          if (!sgItems.length) {
            const empty = document.createElement("div");
            empty.className = "muted";
            empty.style.padding = "2px 2px 8px";
            empty.textContent = "Sem itens neste subgrupo.";
            list.appendChild(empty);
          }

          for (const it of sgItems) {
            const row = document.createElement("div");
            row.className = "item" + (it.checked ? " checked" : "");

            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.className = "chk";
            chk.checked = it.checked;
            chk.addEventListener("change", () => toggleChecked(it.id, chk.checked));

            const text = document.createElement("div");
            text.className = "text";
            text.textContent = it.text;
            text.title = "Toque para editar";
            text.addEventListener("click", () => openEdit(it.id));

            const actions = document.createElement("div");
            actions.className = "actions";

            const upBtn = document.createElement("button");
            upBtn.className = "iconBtn moveBtn";
            upBtn.textContent = "‚Üë";
            upBtn.title = "Subir";
            upBtn.addEventListener("click", () => moveItemWithinSubgroup(it.id, -1));

            const downBtn = document.createElement("button");
            downBtn.className = "iconBtn moveBtn";
            downBtn.textContent = "‚Üì";
            downBtn.title = "Descer";
            downBtn.addEventListener("click", () => moveItemWithinSubgroup(it.id, +1));

            const editBtn = document.createElement("button");
            editBtn.className = "iconBtn";
            editBtn.textContent = "‚úèÔ∏è";
            editBtn.title = "Editar";
            editBtn.addEventListener("click", () => openEdit(it.id));

            const delBtn = document.createElement("button");
            delBtn.className = "iconBtn danger";
            delBtn.textContent = "üóëÔ∏è";
            delBtn.title = "Excluir";
            delBtn.addEventListener("click", () => removeItem(it.id));

            actions.appendChild(upBtn);
            actions.appendChild(downBtn);
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            row.appendChild(chk);
            row.appendChild(text);
            row.appendChild(actions);

            list.appendChild(row);
          }

          sgWrap.appendChild(list);
          box.appendChild(sgWrap);
        }

        details.appendChild(summary);
        details.appendChild(box);

        $groups.appendChild(details);
      }

      updateStats();
    }

    // ================= Seed / Load =================
    function seedDefaults() {
      // m√≠nimo
      data.groups = [
        { id: "g1", name: "Carnes & Prote√≠nas", order: 10, open: true },
        { id: "g2", name: "Acompanhamentos", order: 20, open: true },
        { id: "g3", name: "Temperos & B√°sicos", order: 30, open: false },
        { id: "g4", name: "Bebidas", order: 40, open: false },
        { id: "g5", name: "Descart√°veis & Utilidades", order: 50, open: false },
        { id: "g6", name: "Churrasqueira & Fogo", order: 60, open: false },
        { id: "g7", name: "Conforto & Extras", order: 70, open: false },
        { id: "g8", name: "Limpeza & P√≥s", order: 80, open: false }
      ];

      // subgrupos (exemplo)
      data.subgroups = [];
      for (const g of data.groups) {
        data.subgroups.push({ id: uuid(), groupId: g.id, name: "Geral", order: 10 });
      }

      function sgId(groupName) {
        const g = data.groups.find(x => x.name === groupName);
        const sg = data.subgroups.find(x => x.groupId === g.id && x.name === "Geral");
        return { gid: g.id, sgid: sg.id };
      }

      const defaults = [
        ["Carv√£o", "Churrasqueira & Fogo"],
        ["Acendedor / isqueiro", "Churrasqueira & Fogo"],
        ["Sal grosso", "Temperos & B√°sicos"],
        ["Gelo", "Bebidas"],
        ["√Ågua", "Bebidas"],
        ["Picanha / fraldinha", "Carnes & Prote√≠nas"],
        ["Lingui√ßa", "Carnes & Prote√≠nas"],
        ["P√£o de alho", "Carnes & Prote√≠nas"],
        ["Queijo coalho", "Carnes & Prote√≠nas"],
        ["Arroz", "Acompanhamentos"],
        ["Farofa", "Acompanhamentos"],
        ["Vinagrete", "Acompanhamentos"],
        ["Pratos e copos", "Descart√°veis & Utilidades"],
        ["Guardanapo", "Descart√°veis & Utilidades"],
        ["Sacos de lixo", "Limpeza & P√≥s"]
      ];

      data.items = [];
      for (const [text, gName] of defaults) {
        const { gid, sgid } = sgId(gName);
        data.items.push({
          id: uuid(),
          text,
          groupId: gid,
          subgroupId: sgid,
          checked: false,
          order: maxItemOrder(sgid) + 10,
          createdAt: Date.now()
        });
      }
      // normaliza
      for (const sg of data.subgroups) normalizeItemOrders(sg.id);

      persist();
    }

    function tryMigrateOld() {
      // migra v2 se existir
      const old = getCookie("bbq_checklist_groups_v2");
      if (!old) return false;
      try {
        const parsed = JSON.parse(old);
        if (!parsed || !Array.isArray(parsed.groups) || !Array.isArray(parsed.items)) return false;

        data.groups = parsed.groups.map(g => ({ id: g.id, name: g.name, order: g.order ?? 10, open: (typeof g.open === "boolean") ? g.open : true }));
        data.subgroups = [];
        // cada grupo ganha "Geral"
        const sgMap = new Map();
        for (const g of data.groups) {
          const sg = { id: uuid(), groupId: g.id, name: "Geral", order: 10 };
          data.subgroups.push(sg);
          sgMap.set(g.id, sg.id);
        }
        data.items = parsed.items.map(it => ({
          id: it.id ?? uuid(),
          text: String(it.text ?? "Item"),
          groupId: it.groupId,
          subgroupId: sgMap.get(it.groupId) || ensureDefaultSubgroup(it.groupId),
          checked: !!it.checked,
          order: it.order ?? 10,
          createdAt: it.createdAt ?? Date.now()
        }));

        // normaliza por subgrupo
        for (const sg of data.subgroups) normalizeItemOrders(sg.id);

        persist();
        return true;
      } catch { return false; }
    }

    function load() {
      const raw = getCookie(COOKIE_NAME);
      if (!raw) {
        data = { groups: [], subgroups: [], items: [] };
        if (!tryMigrateOld()) seedDefaults();
        render();
        return;
      }

      try {
        const parsed = JSON.parse(raw);
        if (parsed && Array.isArray(parsed.groups) && Array.isArray(parsed.subgroups) && Array.isArray(parsed.items)) {
          data = parsed;
        } else {
          data = { groups: [], subgroups: [], items: [] };
          seedDefaults();
        }
      } catch {
        data = { groups: [], subgroups: [], items: [] };
        seedDefaults();
      }

      if (!data.groups.length) seedDefaults();

      // garante Geral em todos
      for (const g of data.groups) ensureDefaultSubgroup(g.id);

      // normaliza items
      for (const sg of data.subgroups) normalizeItemOrders(sg.id);

      render();
    }

    // ================= Events =================
    $newGroup.addEventListener("change", () => {
      const gid = $newGroup.value;
      const sgid = ensureDefaultSubgroup(gid);
      fillSubgroupSelect($newSubgroup, gid, sgid);
    });

    $addBtn.addEventListener("click", () => addItem($newItem.value, $newGroup.value, $newSubgroup.value));
    $newItem.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem($newItem.value, $newGroup.value, $newSubgroup.value); });

    $dlgCancel.addEventListener("click", () => { editingId = null; $editDialog.close(); });
    $dlgSave.addEventListener("click", saveEdit);
    $dlgDelete.addEventListener("click", () => {
      if (!editingId) return;
      if (confirm("Excluir este item?")) {
        const id = editingId;
        editingId = null;
        $editDialog.close();
        removeItem(id);
      }
    });
    $editInput.addEventListener("keydown", (e) => { if (e.key === "Enter") saveEdit(); });

    $editGroup.addEventListener("change", () => {
      const gid = $editGroup.value;
      const sgid = ensureDefaultSubgroup(gid);
      fillSubgroupSelect($editSubgroup, gid, sgid);
    });

    $clearCheckedBtn.addEventListener("click", () => {
      const done = data.items.filter(i => i.checked).length;
      if (!done) return;
      if (!confirm(`Excluir ${done} item(ns) marcado(s)?`)) return;

      const affected = [...new Set(data.items.filter(i => i.checked).map(i => i.subgroupId))];
      data.items = data.items.filter(i => !i.checked);
      affected.forEach(normalizeItemOrders);

      persist();
      render();
    });

    // Manage dialog
    $manageBtn.addEventListener("click", () => {
      renderManageDialog();
      $manageDialog.showModal();
      setTimeout(() => $newGroupName.focus(), 50);
    });
    $manageClose.addEventListener("click", () => $manageDialog.close());
    $addGroupBtn.addEventListener("click", () => {
      addGroup($newGroupName.value);
      $newGroupName.value = "";
      renderManageDialog();
    });
    $newGroupName.addEventListener("keydown", (e) => { if (e.key === "Enter") { addGroup($newGroupName.value); $newGroupName.value=""; renderManageDialog(); } });

    // Export / Import dialogs
    $exportBtn.addEventListener("click", () => {
      $exportText.value = exportAsText();
      $exportDialog.showModal();
    });
    $closeExport.addEventListener("click", () => $exportDialog.close());
    $copyExport.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText($exportText.value);
        alert("Copiado!");
      } catch {
        $exportText.focus();
        $exportText.select();
        alert("N√£o deu para copiar automaticamente. Selecione e copie manualmente.");
      }
    });
    $downloadExport.addEventListener("click", () => {
      downloadText("checklist-churrasco.txt", $exportText.value || exportAsText());
    });

    $importBtn.addEventListener("click", () => {
      $importText.value = "";
      $importDialog.showModal();
      setTimeout(() => $importText.focus(), 50);
    });
    $closeImport.addEventListener("click", () => $importDialog.close());
    $doImport.addEventListener("click", () => {
      const parsed = parseImportText($importText.value);
      if (!parsed) { alert("Texto inv√°lido (n√£o encontrei nenhum grupo/itens)."); return; }
      if (!confirm("Isso vai SUBSTITUIR sua lista atual. Continuar?")) return;
      data = parsed;
      // garante Geral e normaliza
      for (const g of data.groups) ensureDefaultSubgroup(g.id);
      for (const sg of data.subgroups) normalizeItemOrders(sg.id);
      persist();
      render();
      $importDialog.close();
    });

    // ================= Init =================
    load();
  </script>
</body>
</html>
